<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分布式理论、架构设计（自定义RPC） | 84dd</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="shortcut icon" href="/favicon.ico" type="image/png">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.02e0ec98.css" as="style"><link rel="preload" href="/assets/js/app.b269d559.js" as="script"><link rel="preload" href="/assets/js/3.b8d8f798.js" as="script"><link rel="preload" href="/assets/js/56.cd0efe5b.js" as="script"><link rel="preload" href="/assets/js/5.3e753ed6.js" as="script"><link rel="prefetch" href="/assets/js/10.f74897bc.js"><link rel="prefetch" href="/assets/js/11.89f2c95d.js"><link rel="prefetch" href="/assets/js/12.32666805.js"><link rel="prefetch" href="/assets/js/13.9c5a2a2b.js"><link rel="prefetch" href="/assets/js/14.93e68c06.js"><link rel="prefetch" href="/assets/js/15.df86fb6a.js"><link rel="prefetch" href="/assets/js/16.321246cf.js"><link rel="prefetch" href="/assets/js/17.c76c8fca.js"><link rel="prefetch" href="/assets/js/18.01bd6dad.js"><link rel="prefetch" href="/assets/js/19.c1306442.js"><link rel="prefetch" href="/assets/js/20.62096e4d.js"><link rel="prefetch" href="/assets/js/21.b0855dde.js"><link rel="prefetch" href="/assets/js/22.bcc1058a.js"><link rel="prefetch" href="/assets/js/23.ffadeaee.js"><link rel="prefetch" href="/assets/js/24.01e35a8d.js"><link rel="prefetch" href="/assets/js/25.6a15b804.js"><link rel="prefetch" href="/assets/js/26.71b1d4e8.js"><link rel="prefetch" href="/assets/js/27.cab018d1.js"><link rel="prefetch" href="/assets/js/28.b90a1fcd.js"><link rel="prefetch" href="/assets/js/29.d2cf4481.js"><link rel="prefetch" href="/assets/js/30.60746d02.js"><link rel="prefetch" href="/assets/js/31.57a42fa0.js"><link rel="prefetch" href="/assets/js/32.3ae0c8e8.js"><link rel="prefetch" href="/assets/js/33.77f28a97.js"><link rel="prefetch" href="/assets/js/34.97fc9c57.js"><link rel="prefetch" href="/assets/js/35.4c26e91f.js"><link rel="prefetch" href="/assets/js/36.81e2a696.js"><link rel="prefetch" href="/assets/js/37.3cd7d54a.js"><link rel="prefetch" href="/assets/js/38.1204a848.js"><link rel="prefetch" href="/assets/js/39.6e5a7c5a.js"><link rel="prefetch" href="/assets/js/4.169e7cd6.js"><link rel="prefetch" href="/assets/js/40.64f88aaf.js"><link rel="prefetch" href="/assets/js/41.77e642e3.js"><link rel="prefetch" href="/assets/js/42.29dddb96.js"><link rel="prefetch" href="/assets/js/43.03a6ad96.js"><link rel="prefetch" href="/assets/js/44.aa26d2de.js"><link rel="prefetch" href="/assets/js/45.f70e93a5.js"><link rel="prefetch" href="/assets/js/46.d621b8d5.js"><link rel="prefetch" href="/assets/js/47.356411eb.js"><link rel="prefetch" href="/assets/js/48.a95fb581.js"><link rel="prefetch" href="/assets/js/49.34bde8ce.js"><link rel="prefetch" href="/assets/js/50.c4fc2a57.js"><link rel="prefetch" href="/assets/js/51.893e80f7.js"><link rel="prefetch" href="/assets/js/52.1d3da56d.js"><link rel="prefetch" href="/assets/js/53.13ab1f25.js"><link rel="prefetch" href="/assets/js/54.c945c93b.js"><link rel="prefetch" href="/assets/js/55.b1d970d4.js"><link rel="prefetch" href="/assets/js/57.fcb31b78.js"><link rel="prefetch" href="/assets/js/58.ac25443e.js"><link rel="prefetch" href="/assets/js/59.eb7a0085.js"><link rel="prefetch" href="/assets/js/6.9661912c.js"><link rel="prefetch" href="/assets/js/60.f527322d.js"><link rel="prefetch" href="/assets/js/61.adde9f48.js"><link rel="prefetch" href="/assets/js/62.75ee4277.js"><link rel="prefetch" href="/assets/js/63.e0640120.js"><link rel="prefetch" href="/assets/js/64.dd25c700.js"><link rel="prefetch" href="/assets/js/65.d8f8f8d8.js"><link rel="prefetch" href="/assets/js/66.330d31d7.js"><link rel="prefetch" href="/assets/js/67.4162a6ae.js"><link rel="prefetch" href="/assets/js/68.c92d1528.js"><link rel="prefetch" href="/assets/js/69.c5a6f29e.js"><link rel="prefetch" href="/assets/js/7.cadbb06a.js"><link rel="prefetch" href="/assets/js/70.4aabd2fb.js"><link rel="prefetch" href="/assets/js/71.c080b30e.js"><link rel="prefetch" href="/assets/js/72.b0db0502.js"><link rel="prefetch" href="/assets/js/8.893afa69.js"><link rel="prefetch" href="/assets/js/9.3a85cbbf.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.96975ae0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.02e0ec98.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">84dd</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="/docs/resume/" class="nav-link">
  简历
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学不死" class="dropdown-title"><span class="title">学不死</span> <span class="arrow down"></span></button> <button type="button" aria-label="学不死" class="mobile-dropdown-title"><span class="title">学不死</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/java/" class="nav-link router-link-active">
  JAVA系列
</a></li><li class="dropdown-item"><!----> <a href="/docs/es/" class="nav-link">
  ES
</a></li></ul></div></div><div class="nav-item"><a href="/docs/docker/" class="nav-link">
  Docker
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/Mac/" class="nav-link">
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/docs/iTerm2/" class="nav-link">
  iTerm2
</a></li><li class="dropdown-item"><!----> <a href="/docs/chrome/" class="nav-link">
  Chrome
</a></li><li class="dropdown-item"><!----> <a href="/docs/idea/" class="nav-link">
  IntelliJ IDEA
</a></li><li class="dropdown-item"><!----> <a href="/docs/WebStorm/" class="nav-link">
  WebStorm
</a></li></ul></div></div><div class="nav-item"><a href="/docs/JavaPlugin/" class="nav-link">
  Java插件
</a></div><div class="nav-item"><a href="/docs/Python/" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/docs/Shell/" class="nav-link">
  命令行
</a></div><div class="nav-item"><a href="/docs/diverse/" class="nav-link">
  杂项
</a></div> <a href="https://github.com/84dd/84dd.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="/docs/resume/" class="nav-link">
  简历
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学不死" class="dropdown-title"><span class="title">学不死</span> <span class="arrow down"></span></button> <button type="button" aria-label="学不死" class="mobile-dropdown-title"><span class="title">学不死</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/java/" class="nav-link router-link-active">
  JAVA系列
</a></li><li class="dropdown-item"><!----> <a href="/docs/es/" class="nav-link">
  ES
</a></li></ul></div></div><div class="nav-item"><a href="/docs/docker/" class="nav-link">
  Docker
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/Mac/" class="nav-link">
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/docs/iTerm2/" class="nav-link">
  iTerm2
</a></li><li class="dropdown-item"><!----> <a href="/docs/chrome/" class="nav-link">
  Chrome
</a></li><li class="dropdown-item"><!----> <a href="/docs/idea/" class="nav-link">
  IntelliJ IDEA
</a></li><li class="dropdown-item"><!----> <a href="/docs/WebStorm/" class="nav-link">
  WebStorm
</a></li></ul></div></div><div class="nav-item"><a href="/docs/JavaPlugin/" class="nav-link">
  Java插件
</a></div><div class="nav-item"><a href="/docs/Python/" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/docs/Shell/" class="nav-link">
  命令行
</a></div><div class="nav-item"><a href="/docs/diverse/" class="nav-link">
  杂项
</a></div> <a href="https://github.com/84dd/84dd.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JAVA系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/java/" aria-current="page" class="sidebar-link">介绍</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>第一阶段 开源框架源码剖析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>第二阶段 Web服务器深度应用及调优</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>第三阶段 分布式&amp;微服务</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/java/31cloud1.html" aria-current="page" class="active sidebar-link">分布式理论、架构设计（自定义RPC）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#什么是分布式" class="sidebar-link">什么是分布式？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式与集群概念" class="sidebar-link">分布式与集群概念</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式系统面临的问题" class="sidebar-link">分布式系统面临的问题</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式理论-一致性" class="sidebar-link">分布式理论: 一致性</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式理论-cap定理" class="sidebar-link">分布式理论: CAP定理</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式理论-base理论" class="sidebar-link">分布式理论: BASE理论</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式理论-分布式事务" class="sidebar-link">分布式理论: 分布式事务</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式理论-一致性协议-2pc" class="sidebar-link">分布式理论: 一致性协议 2PC</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式理论-一致性协议-3pc" class="sidebar-link">分布式理论: 一致性协议 3PC</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式理论-一致性算法-paxos" class="sidebar-link">分布式理论: 一致性算法 Paxos</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式理论-一致性算法-raft" class="sidebar-link">分布式理论:一致性算法 Raft</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式系统设计策略" class="sidebar-link">分布式系统设计策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#心跳检测" class="sidebar-link">心跳检测</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#高可用设计" class="sidebar-link">高可用设计</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#容错性" class="sidebar-link">容错性</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#负载均衡" class="sidebar-link">负载均衡</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#分布式架构网络通信" class="sidebar-link">分布式架构网络通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#同步和异步" class="sidebar-link">同步和异步</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#阻塞和非阻塞" class="sidebar-link">阻塞和非阻塞</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#bio" class="sidebar-link">BIO</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#nio" class="sidebar-link">NIO</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#aio" class="sidebar-link">AIO</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#rpc" class="sidebar-link">RPC</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#rmi" class="sidebar-link">RMI</a></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#netty" class="sidebar-link">Netty</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/java/31cloud1.html#视频验证" class="sidebar-link">视频验证</a></li></ul></li><li><a href="/docs/java/32zookeeper.html" class="sidebar-link">Zookeeper</a></li><li><a href="/docs/java/33dubbo.html" class="sidebar-link">Dubbo</a></li><li><a href="/docs/java/34springcloud.html" class="sidebar-link">Spring Cloud(SCN)</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="分布式理论、架构设计-自定义rpc"><a href="#分布式理论、架构设计-自定义rpc" class="header-anchor">#</a> 分布式理论、架构设计（自定义RPC）</h1> <p>本模块会对分布式架构的理论、架构设计、网络通信等进行讲解，并设计一个RPC远程过程调用框架并进行代码编写。</p> <h2 id="什么是分布式"><a href="#什么是分布式" class="header-anchor">#</a> 什么是分布式？</h2> <h3 id="分布式与集群概念"><a href="#分布式与集群概念" class="header-anchor">#</a> 分布式与集群概念</h3> <blockquote><p>分布式系统是一个硬件或软件组件分布在不同的网络计算机上，彼此之间仅仅通过消息传递进行通信和协调的系统。</p></blockquote> <ul><li>集群:多个人在一起作同样的事。（同样的项目代码部署多份）</li> <li>分布式:多个人在一起作不同的事。（将项目拆分成很多子系统，子系统间相互调用，而子系统可能会部署在不同的机器、不同的机房、不同的城市）</li></ul> <h3 id="分布式系统面临的问题"><a href="#分布式系统面临的问题" class="header-anchor">#</a> 分布式系统面临的问题</h3> <ul><li>1)通信异常</li> <li>2)网络分区</li> <li>3)节点故障</li> <li>4)三态：成功、失败和超时</li></ul> <h3 id="分布式理论-一致性"><a href="#分布式理论-一致性" class="header-anchor">#</a> 分布式理论: 一致性</h3> <blockquote><p>分布式数据一致性，指的是数据在多份副本中存储时，各副本中的数据是一致的。</p></blockquote> <h4 id="一致性分类"><a href="#一致性分类" class="header-anchor">#</a> 一致性分类</h4> <ul><li>强一致性</li> <li>弱一致性</li> <li>读写一致性</li> <li>单调读一致性</li> <li>因果一致性</li> <li>最终一致性<br>
最终一致性是所有分布式一致性模型当中最弱的。可以认为是没有任何优化的“最”弱一致性，它的意思是说，我不考虑所有的中间 状态的影响，只保证当没有新的更新之后，经过一段时间之后，最终系统内所有副本的数据是正确的。 它最大程度上保证了系统的并发能力，也因此，在高并发的场景下，它也是使用最广的一致性模型。</li></ul> <h3 id="分布式理论-cap定理"><a href="#分布式理论-cap定理" class="header-anchor">#</a> 分布式理论: CAP定理</h3> <p>CAP 理论含义是，一个分布式系统不可能同时满足一致性(C:Consistency)，可用性(A: Availability)和分区容错性 (P:Partition tolerance)这三个基本需求，最多只能同时满足其中的2个。</p> <table><thead><tr><th>选项</th> <th>描述</th></tr></thead> <tbody><tr><td>C 一致性</td> <td>分布式系统当中的一致性指的是所有节点的数据一致，或者说是所有副本的数据一致</td></tr> <tr><td>A 可用性</td> <td>Reads and writes always succeed. 也就是说系统一直可用，而且服务一直保持正常</td></tr> <tr><td>P 分区容错性</td> <td>系统在遇到一些节点或者网络分区故障的时候，仍然能够提供满足一致性和可用性的服务</td></tr></tbody></table> <p><strong>1. 舍弃A(可用性)，保留CP(一致性和分区容错性)</strong><br>
一个系统保证了一致性和分区容错性，舍弃可用性。也就是br说在极端情况下，允许出现系统无法访问的情况出现，这个时候往往会牺牲用户体验，让用户保持等待，一直到系统数据一致了之后，再恢复服务。<br> <strong>2. 舍弃C(一致性)，保留AP(可用性和分区容错性)</strong><br>
这种是大部分的分布式系统的设计，保证高可用和分区容错，但是会牺牲一致性。<br> <strong>3. 舍弃P(分区容错性)，保留CA(一致性和可用性)</strong><br>
如果要舍弃P，那么就是要舍弃分布式系统，CAP也就无从谈起了。可以说P是分布式系统的前提，所以这种情况是不存在的。<br></p> <h3 id="分布式理论-base理论"><a href="#分布式理论-base理论" class="header-anchor">#</a> 分布式理论: BASE理论</h3> <blockquote><p>BASE:全称:Basically Available(基本可用)，Soft state(软状态),和 Eventually consistent(最终一致性)三个短语 的缩写，来自 ebay 的架构师提出。<br>
BASE是对CAP中一致性和可用性权衡的结果，BASE理论的核心思想是: 即使无法做到强一致性，但每个应用都可以 根据自身业务特点，采用适当的方式来使系统达到最终一致性 。</p></blockquote> <h3 id="分布式理论-分布式事务"><a href="#分布式理论-分布式事务" class="header-anchor">#</a> 分布式理论: 分布式事务</h3> <p>事务ACID</p> <ul><li>Atomicity(原子性)</li> <li>Consistency(一致性)</li> <li>Isolation(隔离性)</li> <li>Durablity(持久性)</li></ul> <blockquote><p>其实分布式事务从实质上看与数据库事务的概念是一致的，既然是事务也就需要满足事务的基本特性(ACID)，只 是 分布式事务相对于本地事务而言其表现形式有很大的不同</p></blockquote> <h3 id="分布式理论-一致性协议-2pc"><a href="#分布式理论-一致性协议-2pc" class="header-anchor">#</a> 分布式理论: 一致性协议 2PC</h3> <blockquote><p>2PC ( Two-Phase Commit缩写)即两阶段提交协议，是将整个事务流程分为两个阶段，准备阶段(Prepare phase)、提交阶段(commit phase)，2是指两个阶段，P是指准备阶段，C是指提交阶段。</p></blockquote> <h3 id="分布式理论-一致性协议-3pc"><a href="#分布式理论-一致性协议-3pc" class="header-anchor">#</a> 分布式理论: 一致性协议 3PC</h3> <blockquote><p>3PC，全称 “three phase commit”，是 2PC 的改进版，将 2PC 的 “提交事务请求” 过程一分为二，共形成了由 CanCommit、PreCommit和doCommit三个阶段组成的事务处理协议。
<img src="https://qiniu.84dd.xyz/axAhoQ.png" alt=""></p></blockquote> <h3 id="分布式理论-一致性算法-paxos"><a href="#分布式理论-一致性算法-paxos" class="header-anchor">#</a> 分布式理论: 一致性算法 Paxos</h3> <blockquote><p>Paxos解决了分布式系统一致性问题。</p></blockquote> <h3 id="分布式理论-一致性算法-raft"><a href="#分布式理论-一致性算法-raft" class="header-anchor">#</a> 分布式理论:一致性算法 Raft</h3> <blockquote><p>Raft 是一种为了管理复制日志的一致性算法。</p></blockquote> <p><a href="http://thesecretlivesofdata.com/raft/" target="_blank" rel="noopener noreferrer">Leader选举动画演示<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="分布式系统设计策略"><a href="#分布式系统设计策略" class="header-anchor">#</a> 分布式系统设计策略</h2> <p>在分布式环境下，有几个问题是普遍关心的，我们称之为设计策略:</p> <ul><li>如何检测当前节点还活着?</li> <li>如何保障高可用?</li> <li>容错处理</li> <li>负载均衡</li></ul> <h3 id="心跳检测"><a href="#心跳检测" class="header-anchor">#</a> 心跳检测</h3> <ul><li>周期检测心跳机制<br>
Server端每间隔 t 秒向Node集群发起监测请求，设定超时时间，如果超过超时时间，则判断“死亡”。</li> <li>累计失效检测机制<br>
在周期检测心跳机制的基础上，统计一定周期内节点的返回情况(包括超时及正确返回)，以此计算节点的“死 亡”概率。另外，对于宣告“濒临死亡”的节点可以发起有限次数的重试，以作进一步判断。</li></ul> <blockquote><p>通过周期检测心跳机制、累计失效检测机制可以帮助判断节点是否“死亡”，如果判断“死亡”，可以把该节点踢出集 群</p></blockquote> <h3 id="高可用设计"><a href="#高可用设计" class="header-anchor">#</a> 高可用设计</h3> <p>系统高可用性的常用设计模式包括三种:主备(Master-SLave)、互备(Active-Active)和集群(Cluster)模式</p> <h3 id="容错性"><a href="#容错性" class="header-anchor">#</a> 容错性</h3> <p>容错顾名思义就是IT系统对于错误包容的能力，比如解决缓存穿透</p> <h3 id="负载均衡"><a href="#负载均衡" class="header-anchor">#</a> 负载均衡</h3> <p>负载均衡器有硬件解决方案，也有软件解决方案。硬件解决方案有著名的F5，软件有LVS、HAProxy、Nginx等。</p> <h2 id="分布式架构网络通信"><a href="#分布式架构网络通信" class="header-anchor">#</a> 分布式架构网络通信</h2> <p>网络数据传输的要素：</p> <ul><li>协议
<ul><li>UDP：广播协议，面向无连接，速度快，不安全</li> <li>TCP：面向连接的协议，速度不快，较为安全</li></ul></li> <li>IO
<ul><li>BIO：同步阻塞</li> <li>NIO：非阻塞</li> <li>AIO：非阻塞，异步IO</li></ul></li></ul> <h3 id="同步和异步"><a href="#同步和异步" class="header-anchor">#</a> 同步和异步</h3> <p>同步(synchronize)、异步(asychronize)是指应用程序和内核的交互而言的。</p> <h4 id="同步"><a href="#同步" class="header-anchor">#</a> 同步</h4> <p>指用户进程触发IO操作等待或者轮训的方式查看IO操作是否就绪。</p> <blockquote><p>举例：银行取钱,我自己去取钱,取钱的过程中等待.</p></blockquote> <h4 id="异步"><a href="#异步" class="header-anchor">#</a> 异步</h4> <p>当一个异步进程调用发出之后，调用者不会立刻得到结果。而是在调用发出之后，被调用者通过状态、通知来通知调用者，或者通过回调函数来处理这个调用。
使用异步IO时，Java将IO读写委托给OS处理，需要将数据缓冲区地址和大小传给OS，OS需要支持异步IO操作</p> <blockquote><p>举例：我请朋友帮我取钱,他取到钱后返回给我. (委托给操作系统OS, OS需要支持IO异步API)</p></blockquote> <h3 id="阻塞和非阻塞"><a href="#阻塞和非阻塞" class="header-anchor">#</a> 阻塞和非阻塞</h3> <p>阻塞和非阻塞是针对于进程访问数据的时候,根据IO操作的就绪状态来采取不同的方式.
简单点说就是一种读写操作方法的实现方式. 阻塞方式下读取和写入将一直等待, 而非阻塞方式下,读取和写入方法会 理解返回一个状态值.</p> <h4 id="阻塞"><a href="#阻塞" class="header-anchor">#</a> 阻塞</h4> <blockquote><p>举例：ATM机排队取款，你只能等待排队取款(使用阻塞IO的时候，Java调用会一直阻塞到读写完成才返回。)</p></blockquote> <h4 id="非阻塞"><a href="#非阻塞" class="header-anchor">#</a> 非阻塞</h4> <blockquote><p>举例：柜台取款，取个号，然后坐在椅子上做其他事，等广播通知，没到你的号你就不能去，但你可以不断的问大堂经理 排到了没有。(使用非阻塞IO时，如果不能读写Java调用会马上返回，当IO事件分发器会通知可读写时再继续进行 读写，不断循环直到读写完成)</p></blockquote> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>老张煮开水。 老张，水壶两把(普通水壶，简称水壶;会响的水壶，简称响水壶)。</p> <ul><li>1、同步阻塞：老张把水壶放到火上，站立着等水开。</li> <li>2、同步非阻塞：老张把水壶放到火上，去客厅看电视，时不时去厨房看看水开没有。</li> <li>3、异步阻塞：老张把响水壶放到火上，立等水开。</li> <li>4、异步非阻塞：老张把响水壶放到火上，去客厅看电视，水壶响之前不再去看它了，响了再去拿壶。</li></ul></div> <h3 id="bio"><a href="#bio" class="header-anchor">#</a> BIO</h3> <p>同步阻塞IO。B代表blocking。
服务器实现模式为一个连接一个线程，即客户端有连接请求时服务器端就需要启动一个线程进行处理，如果这个连接不做任何事情会造成不必要的线程开销，当然可以通过线程池机制改善。</p> <div class="language-Java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IOServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//首先创建了一个serverSocket</span>
        <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serverSocket<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">8081</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">Socket</span> socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//同步阻塞</span>
                    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                            <span class="token keyword">int</span> len <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//同步阻塞</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="nio"><a href="#nio" class="header-anchor">#</a> NIO</h3> <p>同步非阻塞IO (non-blocking IO / new io)。服务器实现模式为一个请求一个通道，即客户端发送的连接请求都会注册到多路复用器上，多路复用器轮询到连接 有IO请求时才启动一个线程进行处理。</p> <h4 id="通道-channels"><a href="#通道-channels" class="header-anchor">#</a> 通道(Channels)</h4> <p>NIO 新引入的最重要的抽象是通道的概念。Channel 数据连接的通道。 数据可以从Channel读到Buffers中，也可以从 Buffers 写到Channel中 .</p> <h4 id="缓冲区-buffers"><a href="#缓冲区-buffers" class="header-anchor">#</a> 缓冲区(Buffers)</h4> <p>通道channel可以向缓冲区Buffers中写数据，也可以像Buffers中存数据。</p> <h4 id="选择器-selector"><a href="#选择器-selector" class="header-anchor">#</a> 选择器(Selector)</h4> <p>使用选择器，借助单一线程，就可对数量庞大的活动 I/O 通道实时监控和维护。
<img src="https://qiniu.84dd.xyz/gLrnNZ.png" alt="">
当一个连接创建后，不会需要对应一个线程，这个连接会被注册到多路复用器，所以一个连接只需要一个线程即可，所有的连接需要一个线程就可以操作，该线程的多路复用器会轮训，发现连接有请求时，才开启一个线程处理。</p> <h3 id="aio"><a href="#aio" class="header-anchor">#</a> AIO</h3> <p>异步非阻塞IO。A代表asynchronize</p> <p>当有流可以读时,操作系统会将可以读的流传入read方法的缓冲区,并通知应用程序,对于写操作,OS将write方法的流写 入完毕是操作系统会主动通知应用程序。因此read和write都是异步 的，完成后会调用回调函数。</p> <p>使用场景:连接数目多且连接比较长(重操作)的架构，比如相册服务器。重点调用了OS参与并发操作，编程比较 复杂。Java7开始支持</p> <h3 id="rpc"><a href="#rpc" class="header-anchor">#</a> RPC</h3> <p>RPC全称为remote procedure call，即远程过程调用。借助RPC可以做到像本地调用一样调用远程服务，是一种进程间的通信方式。
<img src="https://qiniu.84dd.xyz/vK0jxo.png" alt=""></p> <ul><li><ol><li>客户端(client)以本地调用方式(即以接口的方式)调用服务;</li></ol></li> <li><ol start="2"><li>客户端存根(client stub)接收到调用后，负责将方法、参数等组装成能够进行网络传输的消息体(将消息体对象序列化为二进制);</li></ol></li> <li><ol start="3"><li>客户端通过sockets将消息发送到服务端;</li></ol></li> <li><ol start="4"><li>服务端存根( server stub)收到消息后进行解码(将消息对象反序列化);</li></ol></li> <li><ol start="5"><li>服务端存根( server stub)根据解码结果调用本地的服务;</li></ol></li> <li><ol start="6"><li>本地服务执行并将结果返回给服务端存根( server stub);</li></ol></li> <li><ol start="7"><li>服务端存根( server stub)将返回结果打包成消息(将结果消息对象序列化);</li></ol></li> <li><ol start="8"><li>服务端(server)通过sockets将消息发送到客户端;</li></ol></li> <li><ol start="9"><li>客户端存根(client stub)接收到结果消息，并进行解码(将结果消息发序列化);</li></ol></li> <li><ol start="10"><li>客户端(client)得到最终结果。</li></ol></li></ul> <p>RPC的目标是要把2、3、4、7、8、9这些步骤都封装起来。</p> <h3 id="rmi"><a href="#rmi" class="header-anchor">#</a> RMI</h3> <p>Java RMI 指的是远程方法调用 (Remote Method Invocation)。MI主要用于不同虚拟机之间的通信。</p> <h4 id="服务端"><a href="#服务端" class="header-anchor">#</a> 服务端</h4> <ul><li>1)定义Remote子接口，在其内部定义要发布的远程方法，并且这些方法都要Throws RemoteException;</li> <li>2)定义 实现远程接口，并且继承:UnicastRemoteObject</li> <li>3)启动服务器:依次完成注册表的启动和远程对象绑定。</li></ul> <div class="el-tabs el-tabs--top el-tabs--border-card"><div class="el-tabs__header is-top"><div class="el-tabs__nav-wrap is-top"><div class="el-tabs__nav-scroll"><div role="tablist" class="el-tabs__nav is-top" style="transform:translateX(-0px);"></div></div></div></div><div class="el-tabs__content"><div role="tabpanel" aria-hidden="true" id="pane-null" aria-labelledby="tab-null" class="el-tab-pane" style="display:none;"><div class="language-Java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Remote</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IHelloService</span> <span class="token keyword">extends</span> <span class="token class-name">Remote</span> <span class="token punctuation">{</span>

    <span class="token comment">//1.定义一个sayHello方法</span>
    <span class="token keyword">public</span>  <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></div> <div role="tabpanel" aria-hidden="true" id="pane-null" aria-labelledby="tab-null" class="el-tab-pane" style="display:none;"><div class="language-Java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">UnicastRemoteObject</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">UnicastRemoteObject</span> <span class="token keyword">implements</span> <span class="token class-name">IHelloService</span> <span class="token punctuation">{</span>

    <span class="token comment">//手动实现父类的构造方法</span>
    <span class="token keyword">public</span> <span class="token class-name">HelloServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//我们自定义的sayHello</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;this is server , say hello to &quot;</span><span class="token operator">+</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></div> <div role="tabpanel" aria-hidden="true" id="pane-null" aria-labelledby="tab-null" class="el-tab-pane" style="display:none;"><div class="language-Java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">MalformedURLException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">AlreadyBoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Naming</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RMIServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">AlreadyBoundException</span><span class="token punctuation">,</span> <span class="token class-name">MalformedURLException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.创建HelloService实例</span>
        <span class="token class-name">IHelloService</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HelloServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.获取注册表</span>
        <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.对象的绑定</span>
        <span class="token comment">//bind方法的参数1:   rmi://ip地址:端口/服务名   参数2:绑定的对象</span>
        <span class="token class-name">Naming</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;//127.0.0.1:8888/rmiserver&quot;</span><span class="token punctuation">,</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></div></div></div> <h4 id="客户端"><a href="#客户端" class="header-anchor">#</a> 客户端</h4> <ul><li>1)通过符合JRMP规范的URL字符串在注册表中获取并强转成Remote子接口对象;</li> <li>2)调用这个Remote子接口对象中的某个方法就是为一次远程方法调用行为。</li></ul> <div class="language-Java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">NotBoundException</span><span class="token punctuation">,</span> <span class="token class-name">MalformedURLException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1.从注册表中获取远程对象 , 强转</span>
    <span class="token class-name">IHelloService</span> service <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IHelloService</span><span class="token punctuation">)</span> <span class="token class-name">Naming</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;//127.0.0.1:8888/rmiserver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2.准备参数</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;laowang&quot;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3.调用远程方法sayHello</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>服务端和客户端都出现过的类<code>IHelloService</code> <code>User</code>这些可以抽取到公共模块</p> <h3 id="netty"><a href="#netty" class="header-anchor">#</a> Netty</h3> <p>Netty 是由 JBOSS 提供一个异步的、 基于事件驱动的网络编程框架。</p> <p>Netty 可以帮助你快速、 简单的开发出一个网络应用， 相当于简化和流程化了 NIO 的开发过程。 作为当前最流行 的 NIO 框架， Netty 在互联网领域、 大数据分布式计算领域、 游戏行业、 通信行业等获得了广泛的应用， 知名的 Elasticsearch 、 Dubbo 框架内部都采用了 Netty。</p> <p>Netty可以在大牛这里进一步学习<a href="https://bugstack.cn/itstack-demo-netty/itstack-demo-netty.html" target="_blank" rel="noopener noreferrer">bugstack虫洞栈<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="为什么使用netty"><a href="#为什么使用netty" class="header-anchor">#</a> 为什么使用Netty</h4> <p>NIO缺点</p> <ul><li>NIO 的类库和 API 繁杂，使用麻烦。你需要熟练掌握 Selector、ServerSocketChannel、SocketChannel、 ByteBuffer 等.</li> <li>可靠性不强，开发工作量和难度都非常大</li> <li>NIO 的 Bug。例如 Epoll Bug，它会导致 Selector 空轮询，最终导致 CPU 100%。</li></ul> <p>Netty优点</p> <ul><li>对各种传输协议提供统一的 API</li> <li>高度可定制的线程模型——单线程、一个或多个线程池</li> <li>更好的吞吐量，更低的等待延迟</li> <li>更少的资源消耗</li> <li>最小化不必要的内存拷贝
<img src="https://qiniu.84dd.xyz/VgSK9c.png" alt=""></li></ul> <h4 id="netty核心组件"><a href="#netty核心组件" class="header-anchor">#</a> Netty核心组件</h4> <h5 id="channelhandler-及其实现类"><a href="#channelhandler-及其实现类" class="header-anchor">#</a> ChannelHandler 及其实现类</h5> <p>ChannelHandler 接口定义了许多事件处理的方法， 我们可以通过重写这些方法去实现具 体的业务逻辑。我们经常需要自定义一个 Handler 类去继承 ChannelInboundHandlerAdapter， 然后通过 重写相应方法实现业务逻 辑， 我们接下来看看一般都需要重写哪些方法:</p> <div class="language-Java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 通道就绪事件</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span>

<span class="token comment">// 通道读取数据事件</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span>

<span class="token comment">// 数据读取完毕事件</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span>

<span class="token comment">// 通道发生异常事件</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="channelpipeline"><a href="#channelpipeline" class="header-anchor">#</a> ChannelPipeline</h5> <p>ChannelPipeline 是一个 Handler 的集合， 它负责处理和拦截 inbound 或者 outbound 的事件和操作， 相当于一个贯穿 Netty 的链。
<code>addFirst</code> 和 <code>addLast</code> 将业务处理类(handler)添加到链的不同位置</p> <h5 id="channelhandlercontext"><a href="#channelhandlercontext" class="header-anchor">#</a> ChannelHandlerContext</h5> <p>这是事件处理器上下文对象， Pipeline 链中的实际处理节点。每个处理节点ChannelHandlerContext 中包含一个具体的事件处理器 ChannelHandler ， 同时 ChannelHandlerContext 中也绑定了对应的 pipeline 和 Channel 的信息，方便对 ChannelHandler 进行调用。 常用方法如下所示</p> <div class="language-Java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 关闭通道</span>
<span class="token class-name">ChannelFuture</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 刷新</span>
<span class="token class-name">ChannelOutboundInvoker</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 将数据写到 ChannelPipeline 中当前ChannelHandler 的下一个 ChannelHandler 开始处理(出站)</span>
<span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="channelfuture"><a href="#channelfuture" class="header-anchor">#</a> ChannelFuture</h5> <p>表示 Channel 中异步 I/O 操作的结果， 在 Netty 中所有的 I/O 操作都是异步的， I/O 的调 用会直接返回， 调用者并
不能立刻获得结果， 但是可以通过 ChannelFuture 来获取 I/O 操作 的处理状态。 常用方法如下所示:</p> <div class="language-Java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 返回当前正在进行 IO 操作的通道</span>
<span class="token class-name">Channel</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 等待异步操作执行完毕</span>
<span class="token class-name">ChannelFuture</span> <span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="eventloopgroup-和其实现类-nioeventloopgroup"><a href="#eventloopgroup-和其实现类-nioeventloopgroup" class="header-anchor">#</a> EventLoopGroup 和其实现类 NioEventLoopGroup</h5> <p>EventLoopGroup 是一组 EventLoop 的抽象， Netty 为了更好的利用多核 CPU 资源， 一般 会有多个 EventLoop 同时 工作， 每个 EventLoop 维护着一个 Selector 实例。 EventLoopGroup 提供 next 接口， 可以从组里面按照一定规则 获取其中一个 EventLoop 来处理任务。 在 Netty 服务器端编程中， 我们一般都需要提供两个 EventLoopGroup， 例 如: BossEventLoopGroup 和 WorkerEventLoopGroup。</p> <h5 id="serverbootstrap-和-bootstrap"><a href="#serverbootstrap-和-bootstrap" class="header-anchor">#</a> ServerBootstrap 和 Bootstrap</h5> <p>ServerBootstrap 是 Netty 中的服务器端启动助手，通过它可以完成服务器端的各种配置; Bootstrap 是 Netty 中的客 户端启动助手， 通过它可以完成客户端的各种配置。 常用方法如下 所示:</p> <h4 id="netty版案例实现"><a href="#netty版案例实现" class="header-anchor">#</a> Netty版案例实现</h4> <div class="el-tabs el-tabs--top el-tabs--border-card"><div class="el-tabs__header is-top"><div class="el-tabs__nav-wrap is-top"><div class="el-tabs__nav-scroll"><div role="tablist" class="el-tabs__nav is-top" style="transform:translateX(-0px);"></div></div></div></div><div class="el-tabs__content"><div role="tabpanel" aria-hidden="true" id="pane-null" aria-labelledby="tab-null" class="el-tab-pane" style="display:none;"><div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.netty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>netty-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.1.6.Final<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div> <div role="tabpanel" aria-hidden="true" id="pane-null" aria-labelledby="tab-null" class="el-tab-pane" style="display:none;"><div class="language-Java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span></span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>string<span class="token punctuation">.</span></span><span class="token class-name">StringDecoder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>string<span class="token punctuation">.</span></span><span class="token class-name">StringEncoder</span><span class="token punctuation">;</span>

<span class="token comment">// 接收客户端请求,打印在控制台</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.创建2个线程池对象</span>
        <span class="token comment">//bossGroup 负责接收用户连接</span>
        <span class="token class-name">NioEventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//workGroup 负责处理用户的io读写操作</span>
        <span class="token class-name">NioEventLoopGroup</span> workGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.创建启动引导类</span>
        <span class="token class-name">ServerBootstrap</span> serverBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.设置启动引导类</span>
        <span class="token comment">//添加到组中,两个线程池,第一个位置的线程池就负责接收,第二个参数就负责读写</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span>workGroup<span class="token punctuation">)</span>
                <span class="token comment">//给我们当前设置一个通道类型</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token comment">//绑定一个初始化监听</span>
                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//事件监听Channel通道</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span> nioSocketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">//获取pipeLine</span>
                        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> nioSocketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//绑定编码</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//绑定我们的业务逻辑</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                                <span class="token comment">//获取入栈信息,打印客户端传递的数据</span>
                                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4.启动引导类绑定端口</span>
        <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5.关闭通道</span>
        future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div></div> <div role="tabpanel" aria-hidden="true" id="pane-null" aria-labelledby="tab-null" class="el-tab-pane" style="display:none;"><div class="language-Java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span></span><span class="token class-name">Bootstrap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelInitializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>string<span class="token punctuation">.</span></span><span class="token class-name">StringEncoder</span><span class="token punctuation">;</span>

<span class="token comment">//客户端给服务器发送数据</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.创建连接池对象</span>
        <span class="token class-name">NioEventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.创建客户端的启动引导类 BootStrap</span>
        <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.配置启动引导类</span>
        bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>
                <span class="token comment">//设置通道为Nio</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token comment">//设置Channel初始化监听</span>
                <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//当前该方法监听channel是否初始化</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">//设置编码</span>
                        channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4.使用启动引导类连接服务器 , 获取一个channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5.循环写数据给服务器</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//给服务器写数据</span>
            channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;hello server .. this is client ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div></div></div></div> <h2 id="视频验证"><a href="#视频验证" class="header-anchor">#</a> 视频验证</h2> <p><video src="https://lagou.84dd.xyz/nettyrpc.mp4" controls="controls" width="700"></video></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/84dd/84dd.github.io/edit/dev/docs/java/31cloud1.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">更新于:</span> <span class="time">a month ago</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/java/22cluster.html" class="prev">
        分布式 &amp;&amp; 集群
      </a></span> <span class="next"><a href="/docs/java/32zookeeper.html">
        Zookeeper
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div class="my-loader center" style="display:none;" data-v-354e1a9e><div class="my-loader-circle" data-v-354e1a9e></div></div><!----><!----></div></div>
    <script src="/assets/js/app.b269d559.js" defer></script><script src="/assets/js/3.b8d8f798.js" defer></script><script src="/assets/js/56.cd0efe5b.js" defer></script><script src="/assets/js/5.3e753ed6.js" defer></script>
  </body>
</html>
